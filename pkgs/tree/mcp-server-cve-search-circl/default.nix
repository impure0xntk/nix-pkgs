# Alternative of https://github.com/cve-search/cve-search
#
# This project cannot build normal buildPythonPackage
# Because regardless of pyproject it does not bundle site-packages deps.
{
  pkgs,
  lib,
  buildUvPackage,
  ...
}:
(buildUvPackage {
  pname = "mcp-server-cve-search-circl";

  src = pkgs.fetchFromGitHub {
    owner = "roadwy";
    repo = "cve-search_mcp";
    rev = "af1b95327d56e7185b473713b8f749ed628bbfb3"; # 2025-08-23
    hash = "sha256-evxQGAhHYqAwmDyFYhLr3+1k+p147AKSaxln9ZIChkU=";
  };
}).overrideAttrs (prev: {
  postInstall = (prev.postInstall or "") + (with pkgs; ''
    mv $out/{bin,share}
    mkdir -p $out/bin
    echo '#!${bash}/bin/bash' > $out/bin/mcp-server-cve-search-circl
    echo "$out/share/python $out/${python3.sitePackages}/main.py \"\$@\"" >> $out/bin/mcp-server-cve-search-circl
    chmod +x $out/bin/mcp-server-cve-search-circl
  '');
  meta.mainProgram = "mcp-server-cve-search-circl";
})
